{% extends "base_template.html" %}
{% load static %}
{% load jformat %}
{% block title %}Title{% endblock %}
{% block head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" xmlns=""/>
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@latest/dist/css/persian-datepicker.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>

{% endblock %}
{% block style %}
    <style>
        .{#@import "https://unpkg.com/open-props" layer(design . system);#}{#@import "https://unpkg.com/open-props/normalize.min.css" layer(demo . support);#} .borderShadow {
            border-radius: 25px;
            box-shadow: rgba(0, 0, 0, 0.25) 0 54px 55px, rgba(0, 0, 0, 0.12) 0 -12px 30px, rgba(0, 0, 0, 0.12) 0 4px 6px,
            rgba(0, 0, 0, 0.17) 0 12px 13px, rgba(0, 0, 0, 0.09) 0 -3px 5px;
        }

        #map {
            height: calc(50vw * 3 / 4);
            width: 50vw;
            border-radius: 25px;
        }

        .nav-tabs {
            flex: 1 0 auto;
        }

        #myTabContent {
            height: 100%; /* Ensure it uses the full height of its parent */
        }

        .tab-pane {
            height: 100%; /* Ensure tab panes also take full height */
        }

        canvas {
            height: 100% !important; /* Make canvas take the full height */
            width: 100% !important; /* Optionally ensure full width */
        }

        .blue-dot {
            background-color: #0000FF;
            border: 2px solid white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: inline-block;
        }
    </style>
{% endblock %}


{% block body %}
    <form method="GET" action="{% url 'indexView' %}">
        <div class="row m-3">
            <div class="col">
                <label for="start_date" class="form-label">تاریخ شروع:</label>
                <input type="text" id="start_date" class="str-date form-control" name="start_date"
                        {% if start_date %}
                       value="{{ start_date | safe }}"
                        {% endif %}/>
                {#    <input type="date" id="start_date" class="form-control" name="start_date">#}
            </div>
            <div class="col">
                <label for="end_date" class="form-label">تاریخ پایان:</label>
                <input type="text" id="end_date" class="end-date form-control" name="end_date"
                        {% if end_date %}

                       value="{{ end_date|safe }}"
                        {% endif %}/>
            </div>
            {#    <input type="date" id="end_date" class="form-control" name="end_date">#}
        </div>
        <div class="row m-3">
            <div class="col-3">
                <button type="submit" class="btn btn-primary">Filter</button>
            </div>
        </div>
    </form>
    <div id="map"></div>

    <div class="container mt-3">
        <div class="row">
            <!-- Tab navigation column -->
            <div class="col-3 d-flex flex-column" id="tabs_container">
                <ul class="nav nav-pills flex-column" id="myTab" role="tablist">
                    {% for item in all_item %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if forloop.first %} active {% endif %}"
                                    id="{{ item }}-tab"
                                    data-bs-toggle="tab"
                                    data-bs-target="#{{ item }}"
                                    type="button" role="tab"
                                    aria-controls="{{ item }}"
                                    aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
                                {{ item }}
                            </button>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <!-- Tab content column -->
            <div class="col-9">
                <div class="tab-content mt-3" id="myTabContent">
                    {% for item in all_item %}
                        <div class="tab-pane {% if forloop.first %} show active{% endif %}"
                             id="{{ item }}"
                             role="tabpanel"
                             aria-labelledby="{{ item }}-tab">
                            <canvas class="{{ item }}" dir="rtl"></canvas>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>


    {#        <ul>#}
    {#            {% for item in all_item %}#}
    {#                <li class="list-group-item">#}
    {#                    <div class="chartWrapper">#}
    {#                        <div class="chartAreaWrapper">#}
    {##}
    {#                            <canvas class="{{ item }}" dir="rtl"></canvas>#}
    {#                        </div>#}
    {#                    </div>#}
    {#                    <div class="axis">#}
    {#                        <span class="testCanvas"></span>#}
    {#                    </div>#}
    {#                </li>#}
    {#            {% endfor %}#}
    {#        </ul>#}
    </div>
{% endblock %}
{% block script %}
    <script src="https://unpkg.com/persian-date@latest/dist/persian-date.js"></script>
    <script src="https://unpkg.com/persian-datepicker@latest/dist/js/persian-datepicker.js"></script>
    {# leaflet script #}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    {#    https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom#}
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="{% static 'node_modules/chartjs-plugin-zoom/dist/chartjs-plugin-zoom.min.js' %}"></script>
    {#    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>#}
    {# map initialization #}
    <script>
        // Initialize the map
        const map = L.map('map').setView([34.800593, 48.522637], 13);


        // Add a tile layer to the map (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Define the data points
        const points = [
            {% for item in data %}
                {
                    "lat": {{item.Lat}}, "lon": {{item.Lng}}, "data": `
                        <b>Average Values of Nearest Neighbors:</b><br>
                        Humidity: {{item.Humidity}}<br>
                        Temperature: {{item.Temperature}}<br>
                        CO: {{item.CO}}<br>
                        H2: {{item.H2}}<br>
                        LPG: {{item.LPG}}<br>
                        CH4: {{item.CH4}}<br>
                        NOx: {{item.NOx}}<br>
                        CL2: {{item.CL2}}<br>
                        Alcohol: {{item.Alchohol}}<br>
                        CO2: {{item.CO2}}<br>
                        Toluene: {{item.Toluen}}<br>
                        NH4: {{item.NH4}}<br>
                        Acetone: {{item.Aceton}}<br>
                        PM1.0: {{item.PM1_0}}<br>
                        PM2.5: {{item.PM2_5}}<br>
                        PM10: {{item.PM10}}
                    `
                },

            {% endfor %}
        ];
        let lastMarker = null;
        let userMarker = null;
        const blueDotIcon = L.divIcon({
            className: 'blue-dot',
            iconSize: [100, 100]
        });
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;

                // Center the map on the user's location
                map.setView([userLat, userLng], 13);

                // Add a marker for the user's location
                userMarker = L.marker([userLat, userLng], {icon: blueDotIcon}).addTo(map);
                {#userMarker.bindPopup("You are here!").openPopup();#}
            });
            var userLat = null;
            var userLng = null;
            // Watch the user's location and update it in real-time
            navigator.geolocation.watchPosition(function (position) {
                userLat = position.coords.latitude;
                userLng = position.coords.longitude;

                if (userMarker) {
                    map.removeLayer(userMarker);
                }

                userMarker = L.marker([userLat, userLng], {icon: blueDotIcon}).addTo(map);
                {#userMarker.bindPopup("You are here!").openPopup();#}

                // Optionally, recenter the map on the user's location
                {#map.setView([userLat, userLng]);#}
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }

        function centerMap() {
            if (userLat !== undefined && userLng !== undefined) {
                map.setView([userLat, userLng], 13);
                {#alert("hi")#}
            } else {

                alert("User location is not available.");
            }
            {#alert("hi")#}
        }

        var CenterControl = L.Control.extend({
            options: {
                position: 'bottomleft' // 'topleft', 'topright', 'bottomleft', 'bottomright'
            },
            onAdd: function (map) {
                var container = L.DomUtil.create('div', 'leaflet-bar');
                var button = L.DomUtil.create('button', '', container);
                button.innerHTML = 'Center on User';
                L.DomEvent.on(button, 'click', function (e) {
                    L.DomEvent.stopPropagation(e);
                    centerMap()
                });
                return container;
            }
        });
        map.addControl(new CenterControl());


        /*
        var circle = L.circle([34.790931, 48.487411], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 600
        }).addTo(map)
        circle.bindPopup("دانشگاه بوعلی");
    */
        map.on('click', function (e) {
            let lat = e.latlng.lat;
            let lng = e.latlng.lng;

            // Make AJAX request
            $.ajax({
                url: '{% url "get_latest_data" %}',  // Replace with your Django view URL
                method: 'POST',
                data: JSON.stringify({lat: lat, lng: lng}),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'  // Include CSRF token for Django
                },
                success: function (response) {
                    console.log('Success:', response);
                    var popupContent = `
                        <b>Average Values of Nearest Neighbors:</b><br>
                        Humidity: ${response.Humidity}<br>
                        Temperature: ${response.Temperature}<br>
                        CO: ${response.CO}<br>
                        H2: ${response.H2}<br>
                        LPG: ${response.LPG}<br>
                        CH4: ${response.CH4}<br>
                        NOx: ${response.NOx}<br>
                        CL2: ${response.CL2}<br>
                        Alchohol: ${response.Alchohol}<br>
                        CO2: ${response.CO2}<br>
                        Toluen: ${response.Toluen}<br>
                        NH4: ${response.NH4}<br>
                        Aceton: ${response.Aceton}<br>
                        PM1.0: ${response.PM1_0}<br>
                        PM2.5: ${response.PM2_5}<br>
                        PM10: ${response.PM10}
                    `;
                    if (lastMarker) {
                        map.removeLayer(lastMarker);
                    }

                    lastMarker = L.marker([lat, lng]).addTo(map);

                    lastMarker.bindPopup(popupContent).openPopup();
                    // Do something with the response if needed
                },
                error: function (error) {
                    console.error('Error:', error);
                }
            });
        });

        // Add points to the map
        points.forEach(function (point) {
            var marker = L.marker([point.lat, point.lon]).addTo(map);
            marker.bindPopup(point.data);
        });
    </script>


    <script>
        let tab = document.getElementById("tabs_container")
        const tab_height = tab.offsetHeight
        console.log(tab_height)
        document.getElementById('myTabContent').style.height = tab_height + "px"
        console.log(document.getElementById("myTabContent").offsetHeight)
        {% for att in all_item %}
            {#<!-- chart of {{ att }} -->#}
            const {{ att|safe }} = document.getElementsByClassName("{{ att }}");
            {#const ctx = document.getElementById('Humidity');#}

            new Chart({{att|safe}}[0], {
                type: 'line',
                data: {

                    labels: [{% for item in data %}[
                        "{{ item.created_at|jformat:"%H:%M" }}","{{ item.created_at|jformat:"%d %B" }}","{{ item.created_at|jformat:"%A" }}",
                        ], {% endfor %}],
                    datasets: [{
                        label: '{{ att|safe }}',
                        data: [{% for key,val in processed_data.items %}{% if key == att %}{% for i in val %}{{ i|safe }}, {% endfor %}{% endif %}{% endfor %}],
                        {#data: [{% for item in processed_data[att.attname] %}{{item}}, {% endfor %}],#}
                        {#borderWidth:#}
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                        tension: 0.2,
                    }],
                    {#borderColor: Utils.CHART_COLORS.blue,#}
                },
                options: {
                    layout: {
                        padding: 1
                    },
                    plugins: {
                        zoom: {
                            limits: {
                                x: {minRange: 5}
                            },
                            animation: {
                                duration: 1000,
                                easing: 'easeOutCubic'
                            },
                            pan: {
                                enabled: true,
                                mode: 'x'
                            },
                            zoom: {
                                wheel: {
                                    enabled: true,
                                    modifierKey: 'ctrl'
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: {
                                display: false
                            },
                            beginAtZero: true,
                            {#offset: true#}
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            offset: true,
                            barPercentage: 1.0,
                            categoryPercentage: 1.0
                        }
                    },
                    animation: {
                        duration: 0
                    },
                    responsive: true,
                    barThickness: 'flex',
                    maxBarThickness: 100,
                    barPercentage: 1.0,
                    categoryPercentage: 1.0,
                    maintainAspectRatio: false
                },
            });

            {#console.log({{ start_date }})#}
        {% endfor %}
    </script>
    <script type="text/javascript">
        function persianToLatinNumbers(input) {
            const persianNumbers = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            const latinNumbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];

            let output = input;
            for (let i = 0; i < 10; i++) {
                const regex = new RegExp(persianNumbers[i], 'g');
                output = output.replace(regex, latinNumbers[i]);
            }
            return output;
        }

        var to, from;
        $(document).ready(function () {
            to = $(".end-date").pDatepicker({
                {#inline: true,#}
                initialValueType: 'persian',
                initialValue: false,
                altField: ".end-date",
                altFormat: 'YYYY/MM/DD HH:MM',
                autoClose: true,
                format: "YYYY/MM/DD HH:MM",
                timePicker: {
                    enabled: true,
                    meridiem: {
                        enabled: true
                    }
                },
                formatter: function (unixDate) {
                    var date = new persianDate(unixDate);
                    return persianToLatinNumbers(date.format('YYYY/MM/DD HH:mm'));
                },
                onSelect: function (unix) {
                    from.touched = true;
                    if (to && to.options && to.options.minDate != unix) {
                        var cachedValue = to.getState().selected.unixDate;
                        to.options = {minDate: unix};
                        if (to.touched) {
                            to.setDate(cachedValue);
                        }
                    }
                }

            });
            from = $(".str-date").pDatepicker({
                initialValueType: 'persian',
                altField: '.str-date',
                altFormat: 'YYYY/MM/DD HH:MM',
                initialValue: false,
                onSelect: function (unix) {
                    to.touched = true;
                    if (from && from.options && from.options.maxDate != unix) {
                        var cachedValue = from.getState().selected.unixDate;
                        from.options = {maxDate: unix};
                        if (from.touched) {
                            from.setDate(cachedValue);
                        }
                    }
                },
                formatter: function (unixDate) {
                    var date = new persianDate(unixDate);
                    return persianToLatinNumbers(date.format('YYYY/MM/DD HH:mm'));
                },
                autoClose: true,
                format: "YYYY/MM/DD HH:MM",
                timePicker: {
                    enabled: true,
                    meridiem: {
                        enabled: true
                    }
                },
            });
        });
    </script>
{% endblock %}